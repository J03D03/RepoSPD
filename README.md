

<div align="center">
    <p>
    <h1>
    RepoSPD
    </h1>
    <img src="logo.png" alt="RepoSPD Logo" style="width: 200px; height: 200px;">
    </p>
    <p>
    (Logo generated by DALL·E 3)
    </p>
    <a href="https://github.com/ddlBoJack/MT4SSL"><img src="https://img.shields.io/badge/Platform-linux-lightgrey" alt="version"></a>
    <a href="https://github.com/ddlBoJack/MT4SSL"><img src="https://img.shields.io/badge/Python-3.8+-orange" alt="version"></a>
    <a href="https://github.com/ddlBoJack/MT4SSL"><img src="https://img.shields.io/badge/License-MIT-red.svg" alt="mit"></a>
</div>



### 📥 Environment
Our code is based on Python3 (>= 3.8). There are a few dependencies to run the code. The major libraries are listed as follows:
```bash
pip install numpy==1.24.4
pip install torch==1.11.0+cu113 torchvision==0.11.0+cu113 torchaudio==0.11.0+cu113
pip install tree-sitter==0.21.1
pip install transformers==4.41.2

# install clang
pip3 install clang==6.0.0.2
sudo apt install clang -y
sudo ln -s /usr/lib/x86_64-linux-gnu/libclang-*.so.1 /usr/lib/x86_64-linux-gnu/libclang.so
# install torch-geometric
pip install torch-scatter==2.0.9 torch-sparse==0.6.13 torch-cluster==1.6.0 torch-spline-conv==1.2.1 torch-geometric -f https://data.pyg.org/whl/torch-1.11.0+cu113.html
# install java 8
sudo apt-get install openjdk-8-jre

```


### 📅 Dateset
We use [**PatchDB**](https://huggingface.co/datasets/sunlab/patch_db) and [**SPI-DB**](https://sites.google.com/view/du-commits/home) as our dataset, respectively.  

```bash
https://huggingface.co/datasets/sunlab/patch_db
```

```bash
(https://sites.google.com/view/du-commits/home)
```

We will release the repository-level datasets：SPIDB* and PatchDB* later.

### 🛠️RepoSPD
#### 🔍 1. Generating MergeCPG

Before you start, please make sure that you've set a correct **absolute** path to the `release` directory in `data_loader.py`

```python
# ./data_preproc/data_loader.py
root = '/path_to_release' # Absolute path to `release`
```

```bash
chmod +x -R ./joern;
cd data_preproc;
python3 data_loader.py;
```

#### ⚖️ 2. RepoCPG Construction
Before you start, please make sure that you've set a correct **absolute** path to the `release` directory in `get_dependency.py` and `add_dep.py`

###### (1) Get repository-level dependency
```bash
cd add_dependency;
python3 get_depend.py;
```

###### (2) MergeCPG to RepoCPG
After getting repository-level dependencies, run`add_dep.py` to add these dependencies to the MergeCPG.
```bash
cd add_dependency;
python3 add_dep.py;
```

#### 🔔 3. Training RepoSPD
Divide your data into 3 subsets: *train*, *valid* and *test* before training. Then set the root path to the 3 subsets in `run.py` by modifying the variables `root` and `dataPath`. Besides, some cached data will be saved to `root` while running.

For example:
```python
# ./run.py
root = './dataset/'
dataPath = root + 'example_dataset' # the 3 subsets are in example_dataset
```

Finally, run!
```bash
python3 run.py
```

